DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE BOOK, BK_ID INT;
	DECLARE FINISHED INT DEFAULT 0;
	DECLARE ALL_BESTSELLERS CURSOR FOR SELECT BOOK_ID FROM RENTS;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
	OPEN ALL_BESTSELLERS;
		WHILE (FINISHED = 0) DO
			FETCH ALL_BESTSELLERS INTO BK_ID;
			IF (FINISHED = 0) THEN
				SELECT COUNT(*) FROM RENTS
                 WHERE BOOK_ID = BK_ID AND RENT_DATE BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
                 INTO BOOK;
                UPDATE BOOKS SET BESTSELLER =  Bestseller(BOOK)
                WHERE BOOK_ID = BK_ID;
				COMMIT;
            END IF;
        END WHILE;
    CLOSE ALL_BESTSELLERS;
END $$

DELIMITER ;

CALL UpdateBestsellers();

SELECT * FROM BOOKS;