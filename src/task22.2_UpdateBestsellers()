DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE EXEMPLAR, BK_ID INT;
	DECLARE FINISHED INT DEFAULT 0;
	DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM RENTS;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
	OPEN ALL_BOOKS;
		WHILE (FINISHED = 0) DO
			FETCH ALL_BOOKS INTO BK_ID;
			IF (FINISHED = 0) THEN
				SELECT COUNT(*) FROM RENTS
                 WHERE BOOK_ID = BK_ID AND RENT_DATE BETWEEN CURDATE() - INTERVAL 30 DAY AND CURDATE()
                 INTO EXEMPLAR;
                UPDATE BOOKS SET BESTSELLER =  Bestseller(EXEMPLAR)
                WHERE BOOK_ID = BK_ID;
				COMMIT;
            END IF;
        END WHILE;
    CLOSE ALL_BOOKS;
END $$

DELIMITER ;

CALL UpdateBestsellers();

SELECT * FROM BOOKS;